<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Worldstake Prototype — Phase 1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --ui-bg:#0f172a;
      --panel:#0b1220;
      --accent:#60a5fa;
      --muted:#94a3b8;
      color-scheme: dark;
    }
    body{font-family:Inter,system-ui,Segoe UI,Arial; background: linear-gradient(180deg,#071022,#071827); color:#e6eef8; margin:0; padding:18px; display:flex; gap:18px; min-height:100vh;}
    .left{flex:1; min-width:640px;}
    .right{width:300px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:12px; padding:14px;}
    header h1{margin:0;font-size:18px}
    canvas{width:100%; height:auto; background:#071328; border-radius:8px; display:block; box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    .control{margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    label{font-size:13px; color:var(--muted);}
    input[type=text]{background:#071827; color:#e6eef8; border:1px solid rgba(255,255,255,0.04); padding:6px 8px; border-radius:6px;}
    button{background:var(--accent); color:#022143; border:none; padding:8px 10px; border-radius:8px; cursor:pointer;}
    small.note{display:block; color:var(--muted); margin-top:8px; font-size:12px}
    .owned-list{max-height:220px; overflow:auto; margin-top:10px; font-size:13px;}
    .owned-item{padding:6px; border-radius:6px; display:flex; gap:8px; align-items:center; margin-bottom:6px; background:rgba(255,255,255,0.01);}
    .color-swatch{width:20px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,0.6);}
  </style>
</head>
<body>
  <div class="left">
    <header>
      <h1>Worldstake — Phase 1 prototype</h1>
      <small class="note">Click the canvas to inspect or claim a pixel. Claimed pixels are saved to your browser (localStorage).</small>
    </header>

    <main style="margin-top:12px">
      <canvas id="mapCanvas" width="1000" height="500"></canvas>
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
        <button id="toggleClaimBtn">Enter Claim Mode</button>
        <div id="status" style="color:var(--muted); font-size:13px;">Mode: <strong id="modeLabel">View</strong></div>
      </div>
    </main>
  </div>

  <aside class="right">
    <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <div>
        <div style="font-weight:600">Controls</div>
        <div style="font-size:13px; color:var(--muted)">Prototype: no payments yet</div>
      </div>
      <img src="" alt="" style="width:28px; opacity:.3;">
    </div>

    <div class="control" style="margin-top:12px;">
      <label for="ownerName">Owner name</label>
      <input id="ownerName" type="text" placeholder="Your name (for demo)" value="anon" />
    </div>

    <div class="control">
      <label for="colorPicker">Color</label>
      <input id="colorPicker" type="color" value="#ff9900" />
      <button id="clearBtn" style="background:#ef4444;color:white;">Clear data</button>
    </div>

    <div style="margin-top:12px; font-size:13px;">
      <div><strong>Pixel info</strong></div>
      <div id="pixelInfo" style="color:var(--muted); margin-top:6px;">Click or hover a pixel to see coordinates and owner.</div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:600; font-size:13px;">Your owned pixels</div>
      <div id="ownedList" class="owned-list"></div>
    </div>

    <div style="margin-top:12px; font-size:12px; color:var(--muted)">
      <div><strong>Notes</strong></div>
      <ul style="padding-left:18px;">
        <li>Each cell is a demo "pixel".</li>
        <li>Data stored locally — clearing browser storage will remove claims.</li>
      </ul>
    </div>
  </aside>

<script>
/*
Worldstake Phase 1 prototype (static)
- Canvas grid
- Claim pixels (saved to localStorage)
- Color picker + owner name
*/

const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d', { alpha: false });

// Grid configuration
const CELL_SIZE = 5;          // pixel size on canvas (in canvas pixels)
const GRID_COLS = Math.floor(canvas.width / CELL_SIZE); // e.g., 1000/5 = 200
const GRID_ROWS = Math.floor(canvas.height / CELL_SIZE); // e.g., 500/5 = 100
const STORAGE_KEY = 'worldstake_pixels_v1';

// UI elements
const colorPicker = document.getElementById('colorPicker');
const ownerNameInput = document.getElementById('ownerName');
const toggleClaimBtn = document.getElementById('toggleClaimBtn');
const modeLabel = document.getElementById('modeLabel');
const pixelInfo = document.getElementById('pixelInfo');
const ownedList = document.getElementById('ownedList');
const clearBtn = document.getElementById('clearBtn');

let claimMode = false;
let pixels = {}; // mapping "x_y" => { color, owner }

// --- Helpers for storage ---
function loadPixels(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return {};
    return JSON.parse(raw);
  }catch(e){
    console.error('Failed to load pixels', e);
    return {};
  }
}
function savePixels(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(pixels));
  }catch(e){
    console.error('Failed to save pixels', e);
  }
}
function resetPixels(){
  if(confirm('Clear all local pixel data? This will remove all claims stored in this browser.')){
    pixels = {};
    savePixels();
    drawAll();
    renderOwnedList();
  }
}

// --- Drawing ---
function drawGrid(){
  ctx.fillStyle = '#071328';
  ctx.fillRect(0,0,canvas.width, canvas.height);

  // optional faint grid
  ctx.strokeStyle = 'rgba(255,255,255,0.02)';
  ctx.lineWidth = 1;
  for(let c=0;c<=GRID_COLS;c++){
    ctx.beginPath();
    const x = c*CELL_SIZE + 0.5; // crisp lines
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
    ctx.stroke();
  }
  for(let r=0;r<=GRID_ROWS;r++){
    ctx.beginPath();
    const y = r*CELL_SIZE + 0.5;
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
}

function drawPixels(){
  for(const key in pixels){
    const [x,y] = key.split('_').map(Number);
    const p = pixels[key];
    ctx.fillStyle = p.color || '#ffffff';
    ctx.fillRect(x*CELL_SIZE, y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
  }
}

function drawAll(){
  // full redraw (grid + pixels)
  drawGrid();
  drawPixels();
}

// --- Interaction ---
function canvasCoordsToCell(clientX, clientY){
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = Math.floor((clientX - rect.left) * scaleX / CELL_SIZE);
  const y = Math.floor((clientY - rect.top) * scaleY / CELL_SIZE);
  return {x: clamp(x, 0, GRID_COLS-1), y: clamp(y, 0, GRID_ROWS-1)};
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

canvas.addEventListener('mousemove', (ev) => {
  const cell = canvasCoordsToCell(ev.clientX, ev.clientY);
  const key = `${cell.x}_${cell.y}`;
  if(pixels[key]){
    pixelInfo.innerHTML = `Coord: <strong>${cell.x},${cell.y}</strong> — Owned by <strong>${escapeHtml(pixels[key].owner||'unknown')}</strong>`;
  }else{
    pixelInfo.innerHTML = `Coord: <strong>${cell.x},${cell.y}</strong> — <em>unclaimed</em>`;
  }
});

canvas.addEventListener('click', (ev) => {
  const cell = canvasCoordsToCell(ev.clientX, ev.clientY);
  const key = `${cell.x}_${cell.y}`;

  if(claimMode){
    // Claim the pixel (if free)
    if(pixels[key]){
      if(!confirm('This pixel is already claimed locally. Overwrite?')) return;
    }
    const color = colorPicker.value;
    const owner = ownerNameInput.value.trim() || 'anon';
    pixels[key] = { color, owner, ts: Date.now() };
    savePixels();
    // paint cell directly (fast)
    ctx.fillStyle = color;
    ctx.fillRect(cell.x*CELL_SIZE, cell.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
    renderOwnedList();
    pixelInfo.innerHTML = `Claimed ${cell.x},${cell.y} as ${escapeHtml(owner)} (${color})`;
  } else {
    // view-only: show info / choose color for selected owner
    if(pixels[key]){
      const p = pixels[key];
      pixelInfo.innerHTML = `Coord: <strong>${cell.x},${cell.y}</strong> — Owned by <strong>${escapeHtml(p.owner)}</strong> color <span style="display:inline-block;width:12px;height:10px;background:${p.color};border:1px solid rgba(0,0,0,0.6);margin-left:6px;vertical-align:middle"></span>`;
    } else {
      if(confirm('Pixel is unclaimed. Enter claim mode to claim it?')){
        setClaimMode(true);
      }
    }
  }
});

// UI actions
toggleClaimBtn.addEventListener('click', () => setClaimMode(!claimMode));
clearBtn.addEventListener('click', resetPixels);

function setClaimMode(on){
  claimMode = !!on;
  modeLabel.textContent = claimMode ? 'Claim' : 'View';
  toggleClaimBtn.textContent = claimMode ? 'Exit Claim Mode' : 'Enter Claim Mode';
  toggleClaimBtn.style.background = claimMode ? '#10b981' : '';
}

// list of owned pixels by current ownerName
function renderOwnedList(){
  const me = (ownerNameInput.value || 'anon').trim();
  const items = [];
  for(const key in pixels){
    if(pixels[key].owner === me) items.push({ key, info: pixels[key] });
  }
  ownedList.innerHTML = '';
  if(items.length === 0){
    ownedList.innerHTML = '<div style="color:var(--muted)">No pixels owned by this name in local storage.</div>';
    return;
  }
  // show up to 200 entries (safety)
  items.slice(0,200).forEach(it => {
    const div = document.createElement('div');
    div.className = 'owned-item';
    const coords = it.key;
    const sw = document.createElement('div');
    sw.className = 'color-swatch';
    sw.style.background = it.info.color;
    const text = document.createElement('div');
    text.innerHTML = `<div style="font-size:13px">${coords.replace('_',',')}</div><div style="color:var(--muted); font-size:12px">claimed ${(new Date(it.info.ts)).toLocaleString()}</div>`;
    div.appendChild(sw);
    div.appendChild(text);
    ownedList.appendChild(div);
  });
}

// small helper
function escapeHtml(s){ return (''+s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// initialize
function init(){
  pixels = loadPixels();
  drawAll();
  setClaimMode(false);
  renderOwnedList();
}
init();

// update list when owner name changes
ownerNameInput.addEventListener('change', renderOwnedList);
ownerNameInput.addEventListener('input', renderOwnedList);

// Optional: visualize hovered cell with border (lighter)
let hoverCell = null;
canvas.addEventListener('mousemove', (ev) => {
  // redraw hovered border
  const cell = canvasCoordsToCell(ev.clientX, ev.clientY);
  if(!hoverCell || hoverCell.x !== cell.x || hoverCell.y !== cell.y){
    hoverCell = cell;
    // redraw base and then hover rect on top
    drawAll();
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 1;
    ctx.strokeRect(cell.x*CELL_SIZE+0.5, cell.y*CELL_SIZE+0.5, CELL_SIZE-1, CELL_SIZE-1);
  }
});
canvas.addEventListener('mouseleave', () => { drawAll(); pixelInfo.textContent = 'Hover or click a pixel to see info.'; });

// make canvas crisp on high-DPI screens
(function adjustForDPR(){
  const dpr = window.devicePixelRatio || 1;
  if(dpr === 1) return;
  const styleW = canvas.clientWidth;
  const styleH = canvas.clientHeight;
  canvas.width = Math.floor(styleW * dpr);
  canvas.height = Math.floor(styleH * dpr);
  ctx.scale(dpr, dpr);
  // need to recalc GRID_COLS/ROWS? We use canvas.width earlier; for simplicity we won't change CELL_SIZE but drawing will remain okay for demo.
  drawAll();
})();
</script>
</body>
</html>
